<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keil输出汇编程序 | 知识文档</title>
    <!-- 引入网站图标 -->
    <link rel="icon" type="image/svg+xml" href="../../static/images/favicon.svg">
    <!-- 引入字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;600&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- 引入图标 -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 代码高亮 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    
    <!-- 引入全局样式 -->
    <link rel="stylesheet" href="../../static/css/style.css">

    <style>
        /* --- 本地覆盖样式 (文章专用) --- */
        body {
            padding-top: 80px; /* 给固定导航栏留位置 */
        }

        /* 头部样式复用 */
        .article-header {
            background: rgba(11, 17, 32, 0.95);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 5%;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-btn {
            text-decoration: none;
            color: var(--primary);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.3s;
        }

        .back-btn:hover {
            color: #fff;
            text-shadow: 0 0 10px var(--primary);
        }

        /* 布局容器 */
        .layout {
            display: flex;
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
            gap: 40px;
        }

        /* 文章内容区域 */
        article {
            flex: 1;
            background: rgba(30, 41, 59, 0.6);
            padding: 40px;
            border-radius: 12px;
            border: 1px solid var(--border);
            backdrop-filter: blur(5px);
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            max-width: 900px;
        }

        /* 侧边目录栏 */
        aside {
            flex: 0 0 250px;
            position: sticky;
            top: 100px;
            height: fit-content;
            display: none;
        }

        @media (min-width: 1100px) {
            aside { display: block; }
        }

        /* --- Markdown 内容排版 --- */
        h1 {
            text-align: center;
            font-size: 2.2rem;
            margin-bottom: 2rem;
            color: #fff;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
            font-family: 'Orbitron', sans-serif;
        }

        h2 {
            font-size: 1.6rem;
            margin-top: 3rem;
            margin-bottom: 1rem;
            color: var(--primary);
            border-left: 5px solid var(--primary);
            padding-left: 15px;
            font-family: 'Orbitron', sans-serif;
        }

        h3 {
            font-size: 1.3rem;
            margin-top: 2rem;
            margin-bottom: 0.8rem;
            color: #fff;
            font-family: 'Fira Code', monospace;
        }

        p, li {
            color: var(--text-main);
            margin-bottom: 1rem;
            font-family: 'Segoe UI', sans-serif;
            line-height: 1.8;
            text-indent: 2em; /* 首行缩进 */
        }

        li { text-indent: 0; } /* 列表不缩进 */

        /* 引用块 */
        blockquote {
            border-left: 4px solid var(--accent);
            background: rgba(16, 185, 129, 0.05);
            padding: 1rem;
            margin: 1.5rem 0;
            color: #d1d5db;
        }
        
        blockquote p {
            margin: 0;
            text-indent: 0;
        }

        /* --- 核心：折叠代码块样式 --- */
        details {
            background: #0d1117;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin: 1.5rem 0;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        summary {
            padding: 12px 20px;
            cursor: pointer;
            color: var(--accent);
            font-family: 'Fira Code', monospace;
            font-weight: bold;
            background: rgba(16, 185, 129, 0.1);
            transition: 0.3s;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        summary:hover {
            background: rgba(16, 185, 129, 0.2);
        }

        summary::after {
            content: 'Click to Expand [+]';
            font-size: 0.8em;
            color: var(--text-muted);
            font-weight: normal;
        }

        details[open] summary::after {
            content: 'Click to Collapse [-]';
        }

        /* 代码块内部样式 */
        pre {
            margin: 0 !important;
            border: none !important;
            border-top: 1px solid var(--border) !important;
            border-radius: 0 !important;
            max-height: 600px; /* 限制最大高度，超过显示滚动条 */
            overflow-y: auto;
            text-indent: 0;
        }
        
        code {
            font-family: 'Fira Code', monospace;
            text-indent: 0;
        }

        hr {
            border: 0;
            border-top: 1px solid var(--border);
            margin: 3rem 0;
        }

        /* 目录样式 */
        .toc-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
        }
        .toc-list { list-style: none; }
        .toc-list li { margin-bottom: 10px; }
        .toc-list a {
            color: var(--text-muted);
            font-size: 0.9rem;
            transition: 0.2s;
            display: block;
            border-left: 2px solid transparent;
            padding-left: 10px;
            text-decoration: none;
        }
        .toc-list a:hover, .toc-list a.active {
            color: var(--accent);
            border-left-color: var(--accent);
        }
    </style>
</head>
<body>

    <!-- 动态背景容器 -->
    <div class="circuit-bg">
        <div class="line v-line" style="--delay: 0s; --left: 10%;"></div>
        <div class="line v-line" style="--delay: 5s; --left: 90%;"></div>
        <div class="line h-line" style="--delay: 2s; --top: 20%;"></div>
        <div class="line h-line" style="--delay: 7s; --top: 80%;"></div>
    </div>

    <!-- 顶部导航 -->
    <header class="article-header">
        <!-- 返回按钮：ID 用于 JS 动态修改链接 -->
        <a id="back-btn" href="../../archive/archive.html?cat=all" class="back-btn">
            <i class="fas fa-chevron-left"></i> <span>Back to Archive</span>
        </a>
        <div style="font-family: 'Fira Code'; color: var(--text-muted); font-size: 0.9rem;">
            system.read(mode=asm_debug)
        </div>
    </header>

    <div class="layout">
        <!-- 侧边目录 (TOC) -->
        <aside>
            <div class="toc-title">DIRECTORY</div>
            <ul class="toc-list">
                <li><a href="#sec-1">一、为什么要看汇编程序文件</a></li>
                <li><a href="#sec-2">二、Keil输出.asm汇编程序文件</a></li>
            </ul>
        </aside>

        <!-- 文章内容 -->
        <article>
            <h1>Keil输出汇编程序文件反推程序流程</h1>

            <h2 id="sec-1">一、为什么要看汇编程序文件</h2>
            <p>在实际编程过程中，尤其是在编写较大的工程代码时，我们的程序编写过程不会是按部就班一行一行去编写的，我们的程序在多个.C文件中跳跃，如果工程中还涉及到各种中断那么程序的流程就非常复杂了，加之现在主流的HAL库还存在各种回调函数…………如果程序能够正常执行，完整无误的跑完整个流程当然是皆大欢喜，可是如果输出的结果并不是我们想要的，那么想要知道哪里出了问题就会非常让人头大，这可能就是程序员头发少的原因吧（bushi）。虽然Keil也提供了Debug工具，我们可以通过添加断点的方式来判断程序在哪里出现了问题，但是，由于单片机程序所使用的函数接口被封装了很多层，我们无法通过一行C语言代码就能知道问题真实存在于何处，举个例子（在中断中使用串口发送不正常，无法跳出某个中断等等）当这些问题出现的时候，往往会卡死在HAL_XXX_XXX()语句中，我们需要一步一步追进去施加断点，需要看程序具体死在了哪一步，在go definition的过程中我们在好几个.C文件中跳来跳去，混乱且麻烦。所以为了更好的去理解我们的程序具体是怎么执行的更细节的知道错误在哪里，我们就需要去看汇编程序文件。</p>

            <hr>

            <h2 id="sec-2">二、Keil输出.asm汇编程序文件</h2>
            <p>那么我们怎么去看汇编程序文件，或者我们怎么得到它呢，有两种方式，一种就是Keil Debug自带的反汇编调试部分，个人是不推荐这种啦，看起来不方便我更推荐下面这种方式输出汇编程序文件。</p>
            
            <ol style="margin-left: 1em; color: var(--text-main);">
                <li>打开Keil工程，点击Options for Target（魔术棒）。</li>
                <li>点击User菜单栏，找到After Build/Rebuild一栏，勾选RUN#2，勾选后填入指令：</li>
            </ol>

            <blockquote>
                <p style="text-indent: 0; font-family: 'Fira Code'; color: var(--accent);">fromelf.exe --text -c -o "$L@L.asm" "#L"</p>
            </blockquote>

            <ol start="3" style="margin-left: 1em; color: var(--text-main);">
                <li>Rebuild工程，编译成功后汇编程序文件即可输出。
                    <ul style="margin-top: 0.5rem;">
                        <li>输出文件后缀为.asm，可以使用NotePad ++ 等编辑器打开。</li>
                    </ul>
                </li>
            </ol>
        </article>
    </div>

    <!-- 音乐播放器挂载 -->
    <div class="music-player-widget">
        <div class="player-controls">
            <button id="prev-btn" title="Previous"><i class="fas fa-step-backward"></i></button>
            <button id="play-btn" title="Play/Pause"><i class="fas fa-play"></i></button>
            <button id="next-btn" title="Next"><i class="fas fa-step-forward"></i></button>
            <button id="mute-btn" title="Mute"><i class="fas fa-volume-up"></i></button>
        </div>
        <div class="song-info">
            <span id="song-title">Loading...</span>
        </div>
        <audio id="bg-music"></audio>
    </div>

    <!-- 定义根路径变量 (由于在 archive/stm32/ 下，所以是 ../../) -->
    <script>var ROOT_PATH = '../../';</script>
    
    <!-- 引入音乐脚本 -->
    <script src="../../static/js/music.js"></script>

    <!-- 引入 Prism.js 核心及 Nasm (汇编) 语言包 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <!-- 使用 nasm 高亮汇编 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-nasm.min.js"></script>
    
    <!-- 核心逻辑：处理返回链接 & 目录高亮 -->
    <script>
        // 1. 处理返回按钮逻辑
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const fromCat = urlParams.get('from'); 
            
            const backBtn = document.getElementById('back-btn');
            
            if (fromCat) {
                // 如果有 from 参数，就用它，处理 c/cpp 的转码
                backBtn.href = `../../archive/archive.html?cat=${encodeURIComponent(fromCat)}`;
                console.log("Back link set to:", backBtn.href);
            } else {
                // 默认回 STM32 分类
                backBtn.href = `../../archive/archive.html?cat=stm32`;
            }
        });

        // 2. 目录滚动监听
        const sections = document.querySelectorAll('h2');
        const navLinks = document.querySelectorAll('.toc-list a');

        window.addEventListener('scroll', () => {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (pageYOffset >= (sectionTop - 200)) {
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(a => {
                a.classList.remove('active');
                if (a.getAttribute('href').includes(current)) {
                    a.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>
